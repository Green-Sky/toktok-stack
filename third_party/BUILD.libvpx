load("@toktok//third_party/yasm:build_defs.bzl", "asm_library")

asm_library(
    name = "assemblies",
    srcs = glob([
        "vp*/**/x86/*.asm",
        "vpx_ports/emms.asm",
    ]),
    hdrs = [
        "third_party/x86inc/x86inc.asm",
        "vpx_ports/x86_abi_support.asm",
        "@toktok//third_party/libvpx:vpx_config.asm",
    ],
    asmopts = [
        "-I$(GENDIR)/external/libvpx",  # Generated headers.
        "-Iexternal/libvpx",
        "-Iexternal/toktok/third_party/libvpx",
    ],
)

genrule(
    name = "regen_config",
    srcs = glob(["**/*"]),
    outs = [
        "vpx_config.asm",
        "vpx_config.h",
        "vpx_version.h",
        "libs-x86_64-linux-gcc.mk",
    ],
    cmd = """
        export PATH=$$PWD/$$(dirname $(location @yasm)):$$PATH
        cd `dirname $(location configure)`
        ./configure --enable-pic
        make vpx_version.h
        DIR=`pwd`
        cd -
        for i in $(OUTS); do
          cp $$DIR/`basename $$i` $$i
        done
    """,
    tools = ["@yasm"],
)

[genrule(
    name = "%s_rtcd" % mod,
    srcs = [
        "build/make/rtcd.pl",
        "@toktok//third_party/libvpx:libs-x86_64-linux-gcc.mk",
        defs,
    ],
    outs = ["%s_rtcd.h" % mod],
    cmd = "$(location build/make/rtcd.pl) --arch=x86_64 --sym=%s_rtcd --config=$(location @toktok//third_party/libvpx:libs-x86_64-linux-gcc.mk) $(location %s) > $@" % (mod, defs),
) for mod, defs in [
    ("vp8", "vp8/common/rtcd_defs.pl"),
    ("vp9", "vp9/common/vp9_rtcd_defs.pl"),
    ("vpx_dsp", "vpx_dsp/vpx_dsp_rtcd_defs.pl"),
    ("vpx_scale", "vpx_scale/vpx_scale_rtcd.pl"),
]]

cc_library(
    name = "headers",
    hdrs = glob(["**/*.h"]) + [
        "vp8_rtcd.h",
        "vp9_rtcd.h",
        "vpx_dsp_rtcd.h",
        "vpx_scale_rtcd.h",
    ],
    deps = [
        "@toktok//third_party/libvpx:vpx_config",
    ],
)

COMMON_SOURCES = glob(
    ["vp*/**/*.c"],
    exclude = [
        "**/arm/**",
        "**/mips/**",
        "**/x86/*_avx2.c",
        "vp8/decoder/error_concealment.c",
        "vp8/encoder/mr_dissim.c",
        "vp9/common/vp9_mfqe.c",
        "vp9/encoder/vp9_denoiser.c",
        "vpx_ports/arm_cpudetect.c",
    ],
)

cc_library(
    name = "libvpx_avx2",
    srcs = glob(["**/x86/*_avx2.c"]),
    copts = [
        "-mavx2",
        "-I$(GENDIR)/external/libvpx",
        "-Iexternal/libvpx",
    ],
    deps = [":headers"],
)

cc_library(
    name = "libvpx",
    srcs = [":assemblies"] + COMMON_SOURCES,
    copts = [
        "-w",
        "-I$(GENDIR)/external/libvpx",
        "-Iexternal/libvpx",
    ],
    includes = ["."],
    linkopts = ["-lm"],
    linkstatic = True,  # XXX Why can't build .so?
    visibility = ["//visibility:public"],
    deps = [
        ":headers",
        ":libvpx_avx2",
        "@toktok//third_party/libvpx:vpx_config",
        "@toktok//third_party/libvpx:vpx_version",
    ],
)
